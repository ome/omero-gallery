
{% extends "webgallery/categories/base.html" %}

{% block content %}

<script>
  // Various global constants from omero config set...
  var FILTER_KEYS = {{ filter_keys|safe }};
  var FILTER_MAPR_KEYS = {{ filter_mapr_keys|safe }};
  var TITLE_KEYS = {{ TITLE_KEYS|safe }};
  var STUDY_SHORT_NAME = {{ STUDY_SHORT_NAME|safe }};
  const GALLERY_INDEX = "{{ gallery_index }}";
  const BASE_URL = "{{ base_url }}";
  const CATEGORY_QUERIES = {{ category_queries|safe }};
  var SUPER_CATEGORY {% if super_category %} = {{ super_category|safe }} {% endif %};
</script>

<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/backdrop.css" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css" />

<style>

  body {
    background-color: #f6f6f9;
  }

  header div {
    position: relative;
  }

  .marketing-hero {
    overflow: hidden;
    position: relative;
    padding: 40px 10px 25px;
    background: black;
    box-shadow: 1px 1px 3px 0px rgb(0 0 0 / 50%);
  }

  a.sites-button.large {
    min-width: 150px;
    font-size: 1.15rem;
    display: block;
    width: fit-content;
    margin: 15px 7px;
  }
  .cats {
    display: flex;
    justify-content: center;
  }
  #search-form {
    padding-top: 10px;
  }
  .hero-subheader {
    margin-bottom: 5px;
    font-size: 1.15rem;
    transition: background-color 1s, color 1s, box-shadow 1s;
  }
  .dark .hero-subheader {
    color: #333333;
    background-color: rgba(255, 255, 255, 0.5);
    box-shadow: 0px 0px 15px 15px rgb(255 255 255 / 50%);
  }
  header h2 {
    transition: color 1s
  }
  .dark h2 {
    color: #333333;
  }
  .stats {
    position: relative;
    text-align: center;
    font-size: 1.7rem;
    color: black;
  }
  .stats span {
    color: #dddddd;
  }
  #studies {
    overflow-x: hidden;
    overflow-y: auto;
    max-height: 350px;
  }
  .studyThumb {
    float: left;
    position: relative;
    margin: 1px 0 1px 2px;
    height: 50px;
    width: 50px;
    overflow: hidden;
    background: no-repeat center;
    background-size: cover;
    background-color: #eee;
  }

  .studyThumb div {
    height: 100%;
    width: 100%;
  }

  .switchLabel {
    font-size: 1.0rem;
    display: inline;
    vertical-align: middle;
    position: relative;
    bottom: 1px;
    color: #999;
  }

  /* https://www.w3schools.com/howto/howto_css_switch.asp */
  /* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 33px;
  height: 20px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.sliderToggle {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.sliderToggle:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .sliderToggle {
  background-color: #333333;
}

input:checked + .sliderToggle:before {
  -webkit-transform: translateX(13px);
  -ms-transform: translateX(13px);
  transform: translateX(13px);
}

/* Rounded sliders */
.sliderToggle.round {
  border-radius: 9px;
}

.sliderToggle.round:before {
  border-radius: 50%;
}

.panel {
  background: white;
  -webkit-box-shadow: 1px 1px 3px 0px rgba(0,0,0,0.5); 
  box-shadow: 1px 1px 3px 0px rgba(0,0,0,0.5);
  padding: 15px;
  width: 100%;
}

.panel .tabs {
  border-width: 0;
  border-bottom-width: 1px;
}

.tabs-title>a[aria-selected=true] {
  background: transparent;
  border-bottom: solid #333 2px;
}
.tabs-title>a:focus {
  background: transparent;
}

/* .twitter-timeline is just while loading twitter */
.tabs-title.is-active a, .tabs-title a, .panel>a.twitter-timeline {
  color: #292F33;
  font-weight: 300;
  font-family: Helvetica,Roboto,"Segoe UI",Calibri,sans-serif;
  font-size: 21px;
  line-height: 24px;
  padding: 5px 25px 9px 25px;
  margin-bottom: -1px;
}
.tabs-content {
  border: none;
}
.tabs-panel {
  padding: 15px 0;
}
.tabs-panel .row {
  margin-bottom: 15px;
}

.tabs-panel .large-6 iframe {
  height: 156px;
}
.tabs-panel .large-12 iframe {
  height: 312px;
}

.expandVideo {
  position: absolute;
  bottom: 0;
  right: -5px;
  background-color: white;
  padding: 5px;
  border-radius: 50%;
}

.large-12 .expandVideo {
  transform: rotate(180deg);
}

.logo-hero{
  opacity: 1;
  transition: opacity 1s;
}

/* hide the white logo when parent has .dark */
.dark .logo-hero{
  opacity: 0;
}

/* tooltip content hidden */
.studyThumb .idr_tooltip {
  display: none;
}

/* tooltip viewer link */
.tippy-content a .fa-eye {
  position: absolute;
  top: 5px; right: 5px;
  color: white
}
.tippy-content a:hover .fa-eye {
  color: #1e94e6;
}
.tooltipThumb {
    float: right;
}

mark {
  background: yellow;
}

</style>


<header class="marketing-hero">

    {% include 'webgallery/categories/background_carousel.html' %}
    <div class="row homepage text-center">
    <div class="medium-12 columns">
      <div style="display:flex; flex-direction: row; margin-bottom: 20px; justify-content: center;">
        <div style="display: inline-block; position: relative; height:62px; width:90px;">
          <img style="left: 0; position: absolute; width:90px; height:62px; margin-bottom: 20px;"
            src="{% static 'gallery/images/idr-icon-dark.svg' %}" alt="IDR logo" class="logo-dark" />
          <img style="left: 0; position: absolute; width:90px; height:62px; margin-bottom: 20px;"
            src="{% static 'gallery/images/idr-icon-white.svg' %}" alt="IDR logo" class="logo-hero" />
        </div>
        {% if category %}
        <h2 style="font-size: 55px; left: 100%; line-height: 1.05; margin-right: 20px; margin-left: 5px; text-transform: capitalize;">{{ category }}</h2>
        {% endif %}
        <div style="display: inline-block; position: relative; height:62px; width:160px; margin-left: -65px;">
          <img style="left: 0; position: absolute; width:160px; height:62px; margin-bottom: 20px;"
            src="{% static 'gallery/images/idr-text-dark.svg' %}" alt="IDR logo" class="logo-dark" />
          <img style="left: 0; position: absolute; width:160px; height:62px; margin-bottom: 20px;"
            src="{% static 'gallery/images/idr-text-white.svg' %}" alt="IDR logo" class="logo-hero" />
        </div>
      </div>
      <!-- <h1 class="hero-main-header">Image Data Resource</h1> -->
      <h2 class="hero-subheader small-10 medium-10 large-10 small-offset-1 medium-offset-1 large-offset-1">
        The Image Data Resource (IDR) is a public repository of image datasets from published scientific studies,
        where the community can submit, search and access high-quality bio-image data.
      </h2>
      <div class="cats">
      {% for c, data in super_categories.items %}
        <a href="{% url 'gallery_super_category' super_category=c %}" class="large button sites-button"
          style="margin-right: 10px; {% if c == category %}background-color: #ffc107{% endif %}">{{ data.label }}</a>
      {% endfor %}
      </div>
    </div>
  </div>

  <div id='search-form' class="row horizontal">
    <div class="small-12 medium-4 large-4 columns">
      <select id="maprConfig">
        {% if filter_keys %}
        <optgroup id="studyKeys" label="Study Attributes">
          {% for key in filter_keys %}
            <option value="{% if key.value %}{{ key.value }}{% else %}{{ key }}{% endif %}">
              {% if key.label %}{{ key.label }}{% else %}{{ key }}{% endif %}
            </option>`
          {% endfor %}
        </optgroup>
        {% endif %}
        <optgroup id="maprKeys" style='display:none' label="Image Attributes">
          <!-- Map-Annotation keys loaded here -->
        </optgroup>
      </select>
    </div>
    <div style="position: relative" class="small-12 medium-8 large-8 columns">
      <input id="maprQuery" type="text" placeholder="Type to filter values...">
      <svg id="spinner" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="sync" role="img"
        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-sync fa-w-16 fa-spin fa-lg">
        <path fill="currentColor"
          d="M440.65 12.57l4 82.77A247.16 247.16 0 0 0 255.83 8C134.73 8 33.91 94.92 12.29 209.82A12 12 0 0 0 24.09 224h49.05a12 12 0 0 0 11.67-9.26 175.91 175.91 0 0 1 317-56.94l-101.46-4.86a12 12 0 0 0-12.57 12v47.41a12 12 0 0 0 12 12H500a12 12 0 0 0 12-12V12a12 12 0 0 0-12-12h-47.37a12 12 0 0 0-11.98 12.57zM255.83 432a175.61 175.61 0 0 1-146-77.8l101.8 4.87a12 12 0 0 0 12.57-12v-47.4a12 12 0 0 0-12-12H12a12 12 0 0 0-12 12V500a12 12 0 0 0 12 12h47.35a12 12 0 0 0 12-12.6l-4.15-82.57A247.17 247.17 0 0 0 255.83 504c121.11 0 221.93-86.92 243.55-201.82a12 12 0 0 0-11.8-14.18h-49.05a12 12 0 0 0-11.67 9.26A175.86 175.86 0 0 1 255.83 432z"
          class=""></path>
      </svg>
    </div>
  </div>
</header>

<div class="row horizontal" style="position: relative; margin-top: 25px; margin-bottom: 15px">
  <div class="small-12 medium-12 large-12 columns">
    <div class="panel" style="float: left; width: 100%">
      <div class="small-12 medium-1 large-2 columns">&nbsp</div>
      <div class="stats small-12 medium-9 large-8 columns" style="position: relative">
        <span id="imageCount" style="color: #333"></span> Images <span>|</span>
        <span id="tbCount" style="color: #333"></span> TB <span>|</span>
        <span id="studyCount" style="color: #333"></span> Studies
      </div>
      <div class="stats small-12 medium-2 large-2 columns" >&nbsp
        <div style="position: absolute; top: 0; right: 15px; width: max-content;">
          <label class="switchLabel">Group by type</label>
          <label class="switch">
            <input id="groupByType" type="checkbox">
            <span class="sliderToggle round"></span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row horizontal" style="position: relative">
  <div class="small-12 medium-12 large-12 columns">
    <div class="panel" style="float: left">
      <input id="filterText" />
      <div id="studies">
        Loading Studies...
      </div>
    </div>
  </div>
</div>

<div class="row horizontal" style="position: relative; margin-top: 15px; margin-bottom: 15px">
  <div class="stats small-12 medium-9 large-8 columns" style="position: relative">
  </div>
</div>

<div class="row horizontal" style="position: relative;">
  <div class="small-12 medium-12 large-8 columns" style>
    <div class="panel">
      <ul class="tabs" data-tabs id="example-tabs">
        <li class="tabs-title is-active"><a href="#panel1" aria-selected="true">
          Exploring IDR
        </a></li>
        <li class="tabs-title"><a data-tabs-target="panel3" href="#panel2">
          Analyse Data
        </a></li>
      </ul>
      <div class="tabs-content" data-tabs-content="example-tabs">
        <div class="tabs-panel is-active" id="panel1">
          {% for video in videos %}
          <div class="row horizontal">
            <div class="small-6 medium-6 large-6 columns" style="position: relative;">
              <iframe id="youtube" width="100%" height="100%" src="https://www.youtube.com/embed/{{ video.id }}"
                title="YouTube video player" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
              </iframe>
              <button title="Expand video" class="expandVideo"><i class="fas fa-angle-right"></i><i class="fas fa-angle-right"></i></button>
            </div>
            <div class="columns small-6 medium-6 large-6">
              <h3>{{ video.title }}</h3>
              {{ video.text }}
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="tabs-panel" id="panel2">
          <p>
            The IDR server is built with <a href="https://www.openmicroscopy.org/omero/">OMERO</a>, allowing access
            to all image data and metadata via an open API in
            <a target="_blank" href="https://docs.openmicroscopy.org/latest/omero/developers/Python.html">Python</a>,
            R,
            <a href="https://docs.openmicroscopy.org/latest/omero/developers/Java.html">Java</a>
            and REST/JSON.
          </p>
          <p>
            The IDR team have developed a number of example analysis notebooks, hosted by third party providers.
            These notebooks allow the establishment of remote analysis environments, accessible through a
            web browser. See the <a target="_blank" href="https://idr.openmicroscopy.org/about/analysis-environments.html">analysis environments</a>
            page for more details.
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="small-12 medium-12 large-4 columns">
    <div class="panel" style="padding: 10px">
    <a class="twitter-timeline" data-height="610" href="https://twitter.com/IDRnews?ref_src=twsrc%5Etfw">Tweets by
      IDRnews</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>    </div>
  </div>
</div>

</div>

<script src="{% static 'gallery/categories.js' %}"></script>
<script src="{% static 'gallery/autocomplete.js' %}"></script>

<script>

  $("#filterText").on("keyup", function(event) {
    let text = event.target.value;
    console.log("filter", text);

    if (text.length == 0) {
      render();
      return;
    }

    let results = model.filterStudiesAnyText(text);
    let html = results.map(studyText => {
      let [study, matchingStrings] = studyText;

      let regexes = text.split(" ").map(token => new RegExp(token, "i"))
      function markup(string){
        return regexes.reduce((prev, regex) => prev.replace(regex, "<mark>$&</mark>"), string)
      }
      let matchingString = matchingStrings.map(markup).join('<br>');

      return `<tr>
        <td>${study.Name}</td>
        <td>${matchingString}</td>
        </tr>`
    }).join("\n");

    document.getElementById('studies').innerHTML = `<table>${html}</table>`;
  });


  $(".expandVideo").on("click", function() {
    let $row = $(this).closest(".row");
    // toggle from 2 columns to 1
    $('.columns', $row).toggleClass("small-12 medium-12 large-12")
    .toggleClass("small-6 medium-6 large-6");
  });
</script>

{% endblock %}
